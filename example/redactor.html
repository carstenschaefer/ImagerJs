<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>ImagerJs - Redactor</title>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="lib/redactor/redactor.css" />
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="lib/redactor/redactor.js"></script>

  <script src="../dist/imagerJs.redactor.min.js"></script>
  <link href="../dist/imagerJs.min.css" rel="stylesheet">

</head>
<body>
  <div class="container">
    <div class="panel panel-default">
      <div class="panel-heading"><h3>ImagerJs - Redactor</h3></div>
      <div class="panel-body">
        <div class="form-group">
          <button class="btn btn-primary" onclick="save()">Save Redactors Content to localStorage</button>
          <button class="btn btn-primary" onclick="load()">Load Redactors Content from localStorage</button>
        </div>
        <div class="form-group">
          <textarea class="redactor" cols="30" rows="10">
            <p>
              Lorem ipsum dolor sit amet, consectetur adipiscing elit.
              Quisque luctus diam nunc, mollis suscipit libero porta
              a. Duis accumsan gravida ex eu bibendum. Vivamus
              facilisis congue lacus, quis consequat tellus interdum
              eu. Sed molestie posuere erat, vitae gravida est
              ultricies tincidunt. Nulla id ornare leo. Nullam
              malesuada laoreet neque ut tempus. Sed leo velit, cursus
              sed dolor quis, imperdiet commodo diam. Praesent
              consequat non metus vitae vestibulum. Vestibulum eu
              fringilla dui. Donec viverra sem vel dui bibendum
              pulvinar. In vulputate leo vitae diam gravida, quis
              egestas turpis gravida. Ut semper lacus turpis, eget
              ultricies turpis pretium sit amet. Vivamus auctor tellus
              ac iaculis pellentesque. Aenean bibendum rutrum lectus,
              quis dictum arcu suscipit et.
            </p>
            <p>
              Phasellus lacinia, mi vitae fermentum euismod, arcu justo fringilla
              felis, at scelerisque dolor nisi ut ligula. Vivamus interdum metus
              nisl, ac egestas nisi tincidunt eget. Donec quis tellus consectetur,
              pretium metus vitae, maximus orci. Phasellus faucibus, nisl a
              ultrices feugiat, orci dolor varius enim, eget ultrices felis justo
              ac mauris. Donec rutrum sodales risus quis sodales. Integer
              porttitor, neque pharetra porta sagittis, nibh est aliquet metus, in
              pulvinar quam felis a quam. Nunc imperdiet volutpat nulla a ornare.
              Integer vel ipsum eget nunc sollicitudin placerat. Nam eu auctor
              nunc. Suspendisse vulputate libero nec vehicula sagittis. Vestibulum
              imperdiet lorem sed efficitur malesuada. Donec volutpat mauris
              felis. Vestibulum id diam eu lectus bibendum sagittis nec accumsan
              felis. Aenean sed ipsum sodales, congue risus at, eleifend urna.
              Vestibulum sit amet blandit eros.
            </p>
            <img src='http://michaelprescott.typepad.com/.a/6a00d83451574c69e201a511c3157d970c-pi' />
          </textarea>
        </div>
      </div>
    </div>
  </div>
  <script>
    ImagerJs.translations.set({
      'Insert': 'Insert'
    });

    var pluginsConfig = {
      Crop: {
        controlsCss: {
          width: '15px',
          height: '15px',
          background: 'white',
          border: '1px solid black'
        },
        controlsTouchCss: {
          width: '25px',
          height: '25px',
          background: 'white',
          border: '2px solid black'
        }
      },
      Rotate: {
        controlsCss: {
          width: '15px',
          height: '15px',
          background: 'white',
          border: '1px solid black'
        },
        controlsTouchCss: {
          width: '25px',
          height: '25px',
          background: 'white',
          border: '2px solid black'
        }
      },
      Resize: {
        controlsCss: {
          width: '15px',
          height: '15px',
          background: 'white',
          border: '1px solid black'
        },
        controlsTouchCss: {
          width: '25px',
          height: '25px',
          background: 'white',
          border: '2px solid black'
        }
      }
    };

    var imagerOptionsPreview = {
      plugins: ['Rotate', 'Crop', 'Resize', 'Toolbar', 'Undo'],
      waitingCursor: 'wait', // for predefined css cursors
      editModeCss: {
        border: '2px solid red',
        background: 'url(../assets/transparent.png)'
      },
      pluginsConfig: pluginsConfig,
      hideFileSelection: false,
	  imageSizeForPerformanceWarning: 20000000 // 20 MB
    };

    var imagerOptionsRedactor = $.extend(true, {}, imagerOptionsPreview);
    imagerOptionsRedactor.plugins = imagerOptionsRedactor.plugins.concat(['Properties', 'Delete']);

    $('.redactor').redactor({
      plugins: ['ImagerJs'],
      ImagerJs: {
        contentConfig: {
          saveImageData: function (imageId, imageData) {
            try {
              console.log('saved ' + imageId);
              localStorage.setItem('image_' + imageId, imageData);
            } catch (err) {
              console.error(err);
              alert('Failed to store image in localStorage. ' +
                    'LocalStorage is used only for demo purposes and you need to provide in-memory ' +
                    'store or device store for use in production. ' +
                    'Please try to lower the quality of the image.');
            }
          },
          loadImageData: function (imageId) {
		        console.log('loaded ' + imageId);
            return localStorage.getItem('image_' + imageId);
          }
        },
        hideFileSelection: true,
        quality: {
          sizes: [
            { label: 'Original', scale: 1, quality: 1, percentage: 100 },
            { label: 'Large', scale: 0.5, quality: 0.5, percentage: 50 },
            { label: 'Medium', scale: 0.2, quality: 0.2, percentage: 20 },
            { label: 'Small', scale: 0.05, quality: 0.05, percentage: 5 }
          ],
          allowCustomSetting: false
        },

        // here we use the same options config, but it is possible to
        // use separate configs to achieve different appearance of imager
        // when selecting image from file and when inside redactor
        redactor: imagerOptionsRedactor,
        preview: imagerOptionsPreview
      }
    });

    var clearContent = function(str) {
        var unclean = 'p&gt;';
        if (str.indexOf(unclean) === 0) {
          str = str.replace(unclean, '');
        }
        return str;
    };

    var save = function () {
      var content = $('.redactor').redactor('code.get');
      localStorage.setItem('content', clearContent(content));

      console.log(content);
    };

    var load = function () {
      // firstly clean all content from redactor
      $('.redactor').redactor('code.set', '');
      $('.redactor').redactor('code.startSync');

      var content = localStorage.getItem('content');

      $('.redactor').redactor('code.set', content);
    };
  </script>
</body>
</html>